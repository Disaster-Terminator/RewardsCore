# 规则分层优化计划

## 问题分析

当前 `project_rules.md` 是全局规则，所有 Agent 都能读取。但其中包含 Master Agent 专属内容，不应暴露给其他 Agent。

### 当前规则归属分析

| 章节 | 归属 | 是否应保留在全局 |
|------|------|------------------|
| 1. 状态标签字典 | 全局 | ✅ 保留（所有 Agent 需要知道标签含义） |
| 2. 通信媒介 | 全局 | ✅ 保留（所有 Agent 需要知道文件用途） |
| 2.1 媒介文件覆写策略 | 全局 | ✅ 保留（所有 Agent 都需要覆写） |
| 3. Master Agent 独占守则 | Master 专属 | ❌ 移到 master.md |
| 4. 身份判定 | 全局 | ✅ 保留 |
| 5. AI 审查处理 | 全局 | ✅ 保留 |
| 6. 熔断器规则 | Master 专属 | ❌ 移到 master.md/skill |
| 7. 微提交保护 | Master 专属 | ❌ 移到 master.md/skill |

---

## 优化目标

1. **全局规则极薄化**：只保留所有 Agent 都需要知道的公共协议
2. **Master 规则本地化**：将 Master 专属规则移入 `master.md` 和 `master-execution` skill
3. **避免信息泄露**：防止其他 Agent 看到不该看到的规则

---

## 实施计划

### Task 1: 精简全局 Rule（project_rules.md）

**保留内容**：
- 状态标签字典（所有 Agent 需要识别标签）
- 通信媒介定义（所有 Agent 需要知道文件用途）
- 媒介文件覆写策略（所有 Agent 都需要遵守）
- 身份判定（全局路由规则）
- AI 审查处理（所有 Agent 需要知道如何处理审查结果）

**移除内容**：
- Master Agent 独占守则 → 移入 master.md
- 熔断器规则 → 移入 master.md 和 master-execution skill
- 微提交保护 → 移入 master.md 和 master-execution skill

### Task 2: 更新 master.md

**新增内容**：
- Master Agent 独占守则（从全局 Rule 移入）
- 熔断器检查职责（核心逻辑，保留在 prompt）
- 微提交保护职责（核心逻辑，保留在 prompt）

**保留原则**：
- prompt 中只保留核心约束和决策逻辑
- 详细步骤保留在 skill 中按需加载

### Task 3: 验证 master-execution skill

**确认内容**：
- 熔断器检查流程（详细步骤）
- 微提交保护流程（详细步骤）
- 与 master.md 的引用关系正确

---

## 优化后的规则分布

```
┌─────────────────────────────────────────────────────────────┐
│              project_rules.md（全局，所有 Agent 可见）        │
├─────────────────────────────────────────────────────────────┤
│  1. 状态标签字典（Tags）                                      │
│  2. 通信媒介（Artifacts）                                     │
│  3. 媒介文件覆写策略                                          │
│  4. 身份判定                                                  │
│  5. AI 审查处理                                               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              master.md（Master Agent 专属）                   │
├─────────────────────────────────────────────────────────────┤
│  - Master Agent 独占守则                                     │
│  - 熔断器检查职责（核心逻辑）                                  │
│  - 微提交保护职责（核心逻辑）                                  │
│  - 状态标签响应规则                                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│         master-execution skill（按需加载详细步骤）            │
├─────────────────────────────────────────────────────────────┤
│  - 熔断器检查流程（详细步骤）                                  │
│  - 微提交保护流程（详细步骤）                                  │
│  - Git 规范                                                   │
│  - 子 Agent 调用                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 预期效果

| 指标 | 优化前 | 优化后 |
|------|--------|--------|
| 全局 Rule 行数 | ~107 行 | ~45 行 |
| Master 专属规则可见性 | 所有 Agent | 仅 Master Agent |
| 规则泄露风险 | 存在 | 消除 |
