# Skill 加载时机与约束传递问题分析

## 问题背景

发现两个相关联的架构问题：

1. **test-agent 没有正确报告 rscore 入口点问题** - 降级策略缺乏"失败原因分离"
2. **Agent 阅读 Skill 的时机不明确** - 可能导致 Agent 缺少信息和约束

---

## 问题 1：降级策略缺乏失败原因分离

### 当前设计

```markdown
| rscore 结果 | python main.py 结果 | 结论 |
|-------------|---------------------|------|
| ❌ 失败 | ❌ 失败 | 业务逻辑问题 |
```

### 问题

当两个都失败时，直接归因为"业务逻辑问题"，**没有区分**：
- rscore 失败的原因是什么？（入口点问题 vs 其他问题）
- python main.py 失败的原因是什么？（环境问题 vs 业务问题）

### 真实情况

| 命令 | 失败原因 | test-agent 判断 |
|------|----------|-----------------|
| rscore | 入口点配置错误（ModuleNotFoundError） | 未单独记录 |
| python main.py | 运行时依赖缺失（会话文件） | 业务逻辑问题 |

两个**不同性质**的失败被合并为一个结论。

---

## 问题 2：Agent 阅读 Skill 的时机不明确

### 当前设计

从 agent 配置文件中：

```markdown
## 执行流程

1. 唤醒后，立即读取 `.trae/current_task.md`
2. 检索并阅读 `dev-execution` skill（按需加载）
3. 修改代码，执行局部验证
```

### 问题分析

**"按需加载"是模糊的**：

| 问题 | 影响 |
|------|------|
| 什么时候算"需要"？ | Agent 自行判断，可能跳过 |
| 如果 Agent 认为不需要？ | Skill 中的约束不会生效 |
| Skill 包含什么？ | 前置检查、阻断协议、详细流程 |

### 约束传递链分析

```
┌─────────────────────────────────────────────────────────────┐
│  Agent 提示词（始终生效）                                     │
│  - 高层约束：禁止猜测、禁止写入 Memory MCP                     │
│  - 状态标签输出规则                                          │
│  - 执行流程（简略）                                          │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│  Skill（按需加载，可能不生效）                                │
│  - 前置检查（强制拦截）                                       │
│  - 环境异常阻断协议                                          │
│  - 详细执行流程                                              │
│  - 错误归因表                                                │
└─────────────────────────────────────────────────────────────┘
```

**关键发现**：前置检查在 Skill 中，但 Agent 可能不阅读 Skill，导致前置检查不生效。

---

## 根因分析

### 问题 1 的根因

**降级策略设计缺陷**：只关注"最终结果"，不关注"中间过程的失败原因"。

### 问题 2 的根因

**约束传递链断裂**：
- Agent 提示词中只有高层约束
- Skill 中有详细的前置检查
- 但 Skill 是"按需加载"，Agent 可能跳过

---

## 改进方案

### 方案 1：增强降级策略的错误分离

修改 `test-execution/SKILL.md`：

```markdown
### 4. E2E 验收（降级执行）

**步骤 1**：尝试 rscore
- 若失败，**记录失败原因**（区分：ModuleNotFoundError / 其他错误）

**步骤 2**：降级到 python main.py
- 若失败，**记录失败原因**

**步骤 3**：综合判断

| rscore 失败原因 | python main.py 失败原因 | 结论 |
|-----------------|------------------------|------|
| ModuleNotFoundError | 任意 | **环境问题**：rscore 入口点配置错误 |
| 任意 | ModuleNotFoundError | **环境问题**：依赖缺失 |
| 其他错误 | 其他错误 | 业务逻辑问题 |
| 其他错误 | 成功 | rscore 入口问题 |
| 成功 | - | 正常 |
```

### 方案 2：强制 Skill 加载

修改 Agent 提示词，将"按需加载"改为"强制加载"：

```markdown
## 执行流程

1. 唤醒后，立即读取 `.trae/current_task.md`
2. **强制阅读** `dev-execution` skill（必须执行，不可跳过）
3. 执行前置检查（来自 Skill）
4. 修改代码，执行局部验证
```

### 方案 3：关键约束上移

将 Skill 中的关键约束（前置检查）提取到 Agent 提示词中：

```markdown
# Constraints（严禁事项）

## 前置检查（强制拦截）

执行任何操作前，必须确认：

- [ ] 文件移动/重命名 → 使用 `Move-Item` 命令
- [ ] 批量删除 → 使用 `Remove-Item` 命令
- [ ] 环境依赖 → 禁止自行安装，发现缺失时触发阻断协议

## 其他约束

1. **绝对禁止**使用 Playwright MCP
...
```

---

## 推荐方案

**组合方案**：方案 1 + 方案 2 + 方案 3

1. **增强降级策略**：修复 test-agent 的问题报告
2. **强制 Skill 加载**：确保 Agent 不会跳过 Skill
3. **关键约束上移**：将前置检查放入 Agent 提示词，作为"双重保险"

---

## 待确认

1. 是否同意增强降级策略的错误分离？
2. 是否同意将 Skill 加载改为强制？
3. 是否同意将前置检查上移到 Agent 提示词？
