# 桌面+移动模式调试文档

## 当前状态
正在调试桌面+移动模式的浏览器切换流程

## 执行流程

### 完整流程
```
1. 初始化 → 创建桌面浏览器
2. 检查登录 → 检查积分
3. 执行桌面搜索 (30次)
4. 【切换点1】保存桌面会话 → 关闭桌面浏览器 → 创建移动浏览器
5. 执行移动搜索 (20次)
6. 【切换点2】保存移动会话 → 关闭移动浏览器 → 创建桌面浏览器
7. 执行日常任务
8. 生成报告 → 关闭浏览器
```

## 关键问题点

### 问题1: beforeunload对话框 ✅
**位置**: 切换点1 - 保存桌面会话时
**现象**: 
- 弹出新的Bing页面
- 显示"确定要离开，可能不会保存更改的框"
- 直到超时

**已实现的解决方案** (`account_manager.save_session`):
1. ✅ **提前设置dialog监听器** - 在处理任何页面前就设置
2. ✅ 为context和所有现有页面设置dialog处理器
3. ✅ 禁用所有页面的beforeunload监听器
4. ✅ 覆盖window.confirm和alert
5. ✅ 关闭额外页面时再次禁用beforeunload

**最新优化** (2026-02-10):
- 将dialog监听器设置移到最前面（步骤0）
- 为context设置page监听器，自动处理新打开的页面
- 简化页面关闭逻辑，避免重复设置监听器

### 问题2: 浏览器切换性能
**当前耗时**: 每次切换约5-10秒
**包含步骤**:
1. 保存会话 (~2秒)
2. 关闭浏览器 (~1秒)
3. 创建新浏览器 (~2-3秒)
4. 加载会话 (~1-2秒)

**优化方向**:
- 减少不必要的等待
- 并行处理某些步骤
- 考虑保持两个浏览器实例

## 调试检查清单

### 运行前检查
- [ ] config.yaml中desktop_count和mobile_count已设置
- [ ] storage_state.json存在且有效
- [ ] 日志级别设置为DEBUG以查看详细信息

### 运行时监控
- [ ] 观察桌面搜索是否正常完成
- [ ] 注意切换点1是否出现对话框
- [ ] 检查移动搜索是否正常开始
- [ ] 注意切换点2是否顺利
- [ ] 确认任务执行是否在桌面浏览器中

### 日志关键点
```
# 切换点1应该看到:
"保存桌面会话状态..."
"当前上下文中有 X 个页面"
"✓ 已禁用页面的 beforeunload"
"✓ 会话状态已保存"
"创建移动浏览器..."

# 切换点2应该看到:
"保存移动会话状态..."
"切换回桌面浏览器以执行任务..."
"✓ 会话状态已保存"
```

## 测试命令

### 完整测试（桌面+移动）
```bash
python main.py
```

### 仅桌面测试（跳过移动）
```bash
python main.py --desktop-only
```

### 仅移动测试（跳过桌面）
```bash
python main.py --mobile-only
```

### 跳过任务测试
```bash
python main.py --skip-daily-tasks
```

## 已知问题和解决方案

### 1. beforeunload对话框卡死 ✅
**解决方案**: 已在save_session中实现
- 禁用beforeunload
- 自动接受dialog
- 多层防护

### 2. 页面未完全关闭
**症状**: 关闭浏览器时仍有页面残留
**解决方案**: 
- 在save_session中关闭所有额外页面
- 只保留第一个页面用于保存状态

### 3. 会话状态丢失
**症状**: 切换后需要重新登录
**解决方案**:
- 确保storage_state.json正确保存
- 验证cookies数量和有效性
- 检查文件权限

## 性能优化建议

### 短期优化
1. ✅ 减少任务间延迟（1-2秒）
2. ✅ 使用domcontentloaded代替networkidle
3. ⏳ 优化save_session等待时间
4. ⏳ 并行处理某些操作

### 长期优化
1. 考虑使用同一浏览器切换user-agent
2. 实现浏览器实例池
3. 添加断点续传功能
4. 优化会话状态管理

## 故障排查步骤

### 如果出现beforeunload对话框:
1. 检查日志中是否有 "✓ 已禁用页面的 beforeunload"
2. 确认dialog监听器是否设置
3. 查看是否有新页面在保存前打开
4. 增加等待时间测试

### 如果切换失败:
1. 检查浏览器是否正确关闭
2. 确认storage_state.json是否更新
3. 查看新浏览器是否成功创建
4. 验证会话是否正确加载

### 如果移动搜索失败:
1. 确认移动浏览器user-agent是否正确
2. 检查移动端登录状态
3. 验证搜索逻辑是否适配移动端
4. 查看页面元素选择器是否正确

## 下一步计划

### 立即执行
1. 运行完整的桌面+移动测试
2. 监控beforeunload对话框是否出现
3. 记录切换耗时
4. 验证积分增长

### 后续优化
1. 根据测试结果调整等待时间
2. 优化dialog处理逻辑
3. 改进错误恢复机制
4. 添加更详细的日志

## 成功标准

### 功能性
- [ ] 桌面搜索完成30次
- [ ] 成功切换到移动浏览器
- [ ] 移动搜索完成20次
- [ ] 成功切换回桌面浏览器
- [ ] 日常任务正常执行

### 稳定性
- [ ] 无beforeunload对话框卡死
- [ ] 无浏览器切换失败
- [ ] 无会话状态丢失
- [ ] 无异常退出

### 性能
- [ ] 总执行时间 < 10分钟
- [ ] 每次切换 < 10秒
- [ ] 积分增长符合预期 (280-300分)
