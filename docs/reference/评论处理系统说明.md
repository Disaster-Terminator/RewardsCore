# 评论处理系统说明

> 最后更新: 2026-02-24

## 概述

评论处理系统用于获取和处理 AI 审查工具（Sourcery/Qodo/Copilot）的评论，提供统一的 CLI 接口和结构化数据存储。

## 架构

### 核心原则

| 原则 | 说明 |
|------|------|
| **Single Source of Truth** | GitHub Thread 是核心操作对象 |
| **API First, DB Second** | 先调用 GitHub API，成功后更新本地数据库 |
| **Thread 为主，Overview 为辅** | Thread 是操作对象，Overview 是只读参考 |

### 数据流

```
GitHub API → GraphQL Client → Resolver → Manager → TinyDB
                ↓
         ReviewThreadState (Thread + enriched_context)
         ReviewOverview (只读参考)
         IssueCommentOverview (只读参考)
```

### 模块结构

```
src/review/
├── models.py           # 数据模型定义
├── parsers.py          # 评论解析器
├── graphql_client.py   # GitHub GraphQL API 客户端
├── resolver.py         # 评论解决器（核心逻辑）
└── comment_manager.py  # 数据持久化管理器
```

## 数据模型

### ReviewThreadState（核心操作对象）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Thread ID（用于解决操作） |
| `source` | str | 来源：Sourcery / Qodo / Copilot |
| `local_status` | str | 状态：pending / resolved / ignored |
| `is_resolved` | bool | GitHub 上的解决状态（只读） |
| `file_path` | str | 文件路径 |
| `line_number` | int \| None | 行号，None 表示文件级评论 |
| `primary_comment_body` | str | 评论内容 |
| `enriched_context` | EnrichedContext | 结构化元数据（可选） |
| `resolution_type` | str | 解决依据类型 |

### EnrichedContext

| 字段 | 类型 | 说明 |
|------|------|------|
| `issue_type` | str | 问题类型（Bug / Security / suggestion 等） |
| `issue_to_address` | str | 问题描述（来自 Sourcery Prompt） |
| `code_context` | str | 代码上下文（来自 Sourcery Prompt） |

### ReviewOverview（只读参考）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Review ID |
| `source` | str | 来源 |
| `high_level_feedback` | list | 高层建议 |
| `has_prompt_for_ai` | bool | 是否包含 Prompt for AI Agents |
| `prompt_overall_comments` | list | Overall Comments |

### IssueCommentOverview（只读参考）

| 字段 | 类型 | 说明 |
|------|------|------|
| `id` | str | Issue Comment ID |
| `source` | str | 来源（Qodo） |
| `user_login` | str | 评论者用户名 |

## CLI 命令

### 获取评论

```bash
python tools/manage_reviews.py fetch --owner OWNER --repo REPO --pr PR_NUMBER
```

输出示例：

```json
{
  "success": true,
  "message": "获取了 14 个线程, 6 个总览意见, 2 个 Issue Comments",
  "threads_count": 14,
  "overviews_count": 6,
  "issue_comments_count": 2
}
```

### 列出评论

```bash
# 表格格式（默认）
python tools/manage_reviews.py list --status pending

# JSON 格式
python tools/manage_reviews.py list --status pending --format json

# 按来源过滤
python tools/manage_reviews.py list --source Qodo
```

表格输出示例：

```
                                      待处理评论 (6)                                      
┏━━━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━┳━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ ID           ┃ Source     ┃ Status     ┃ Enriched     ┃ Location                       ┃
┡━━━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━╇━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ PRRT_kwD...  │ Qodo       │ pending    │ ✅ Bug       │ requirements.txt:1             │  ← 红色
│ PRRT_kwD...  │ Sourcery   │ pending    │ ✅ Sug       │ pyproject.toml:21              │  ← 黄色
└──────────────┴────────────┴────────────┴──────────────┴────────────────────────────────┘
```

### 查看总览意见

```bash
python tools/manage_reviews.py overviews
```

### 查看统计

```bash
python tools/manage_reviews.py stats
```

### 解决评论

```bash
python tools/manage_reviews.py resolve --thread-id THREAD_ID --type RESOLUTION_TYPE [--reply "回复内容"]
```

解决依据类型：

| 类型 | 说明 | 需要回复 |
|------|------|----------|
| `code_fixed` | 代码已修复 | 否 |
| `adopted` | 已采纳建议 | 否 |
| `rejected` | 拒绝建议 | 是 |
| `false_positive` | 误报 | 是 |
| `outdated` | 过时 | 否 |

## 业务规则

### 问题分类

| 分类 | 类型 | 颜色 | 行为 |
|------|------|------|------|
| **必须修复** | Bug, Security, Rule violation, Reliability | 红色 | 报告用户，等待修复指令 |
| **自主决断** | suggestion, Correctness, performance | 黄色 | 报告用户，自主决断 |

### 三种 AI 审查工具

| 工具 | GitHub 用户名 | 特点 |
|------|--------------|------|
| **Sourcery** | `sourcery-ai bot` | 结构化摘要（Prompt for AI Agents），动态解决状态 |
| **Qodo** | `qodo-code-review bot` | 逐行评论（Review Thread），无法通过 @ 解决 |
| **Copilot** | `Copilot AI` | 简单评论，无结构化摘要 |

### Sourcery 动态解决状态

**重要规律**：Sourcery 会根据新推送的 commit 自动检测并更新评论状态：

- 当代码修改解决了某个评论时，Sourcery 会自动标记为 `✅ Addressed in {commit_hash}`
- 这意味着待处理评论数量会随 commit 动态变化
- 获取评论前应确保数据是最新的（重新 fetch）

### 关键区分

| 产物 | 类型 | 是否改进意见 |
|------|------|-------------|
| Sourcery "Reviewer's Guide" | 代码变化摘要 | ❌ 不需要处理 |
| Sourcery "Prompt for AI Agents" | 审查摘要 | ✅ 需要处理 |
| Qodo 逐行评论（Review Thread） | 改进意见 | ✅ 需要处理 |

## 数据存储

### 存储位置

| 文件 | 说明 |
|------|------|
| `.trae/data/review_threads.json` | TinyDB 数据库 |
| `.trae/data/review_threads.lock` | 并发锁 |

### 数据结构

```
review_threads.json
├── metadata 表（单条记录）
│   ├── pr_number
│   ├── owner
│   └── repo
├── threads 表
│   └── ReviewThreadState[]
├── overviews 表
│   └── ReviewOverview[]
└── issue_comment_overviews 表
    └── IssueCommentOverview[]
```

### 注意事项

- 每次获取新 PR 会覆盖 metadata
- threads 表会合并（已存在的更新，新增的插入）
- 切换 PR 时，之前的数据会被新 PR 数据覆盖

## 降级策略

如果 CLI 工具失败，参考 `docs/reference/archive/v1-ai-reviewer-guide.md` 使用 Playwright 手动获取评论。

该文档包含三种机器人的审查评论格式和规律。

## 严禁事项

1. **严禁一次性解决所有评论**：每个评论必须单独处理
2. **严禁无依据标记解决**：必须先确认问题已解决
3. **严禁批量操作**：必须逐个评论处理
4. **严禁跳过说明评论**：rejected/false_positive 必须回复

## 相关文档

- [审查评论处理工作流指南](审查评论处理工作流指南.md)
- [AI 审查工具参考指南（归档）](archive/v1-ai-reviewer-guide.md)
- [fetch-reviews Skill](../../.trae/skills/fetch-reviews/SKILL.md)
