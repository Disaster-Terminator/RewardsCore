# 审查评论处理工作流指南

> 最后更新: 2026-02-24

## 快速入门

本文档帮助 agent 快速理解审查评论处理流程。完整系统文档请参考 [评论处理系统说明](评论处理系统说明.md)。

## 核心概念

### 操作对象 vs 参考对象

| 类型 | 模型 | 用途 | 操作 |
|------|------|------|------|
| **Thread** | `ReviewThreadState` | 主要操作对象 | 可解决、可回复 |
| **Overview** | `ReviewOverview` | 只读参考 | 可确认已阅读 |
| **IssueCommentOverview** | `IssueCommentOverview` | 只读参考 | 仅阅读，不可操作 |

**重要**：Agent 主要操作 Thread 数据。Overview 用于了解 PR 整体评价和高层建议。

### 三种 AI 审查工具

| 工具 | GitHub 用户名 | 特点 |
|------|--------------|------|
| **Sourcery** | `sourcery-ai bot` | 结构化摘要（Prompt for AI Agents），动态解决状态 |
| **Qodo** | `qodo-code-review bot` | 逐行评论（Review Thread），无法通过 @ 解决 |
| **Copilot** | `Copilot AI` | 简单评论，无结构化摘要 |

### Sourcery 动态解决状态

**重要规律**：Sourcery 会根据新推送的 commit 自动检测并更新评论状态：

- 当代码修改解决了某个评论时，Sourcery 会自动标记为 `✅ Addressed in {commit_hash}`
- 这意味着评论数量会随 commit 动态变化
- 获取评论前应确保数据是最新的

## 问题分类

| 分类 | 类型 | 行为 |
|------|------|------|
| **必须修复** | Bug, Security, Rule violation, Reliability, bug_risk, security | 报告用户，等待修复指令 |
| **自主决断** | suggestion, Correctness, performance | 报告用户，自主决断 |

## Agent 工作流示例

```
1. 获取评论状态
   python tools/manage_reviews.py list --status pending --format json

2. 分类处理
   - 遍历 threads，检查 enriched_context.issue_type
   - 必须修复项（Bug/Security）→ 停止，报告用户
   - 自主决断项（suggestion）→ Agent 决定是否采纳

3. 解决已修复项
   python tools/manage_reviews.py resolve --thread-id ID --type code_fixed

4. 拒绝不采纳项
   python tools/manage_reviews.py resolve --thread-id ID --type rejected --reply "原因"

5. 确认总览意见
   python tools/manage_reviews.py acknowledge --all
```

## 问题类型判断代码

```python
MUST_FIX_TYPES = {"Bug", "Security", "Rule violation", "Reliability", "bug_risk", "security"}

def is_must_fix(issue_type: str) -> bool:
    for type_name in MUST_FIX_TYPES:
        if type_name.lower() in issue_type.lower():
            return True
    return False
```

## 常见问题

### Q: Sourcery 的 Reviewer's Guide 需要处理吗？

**A:** 不需要。"Reviewer's Guide" 是代码变化摘要，不是改进意见。应该处理的是 "Prompt for AI Agents"。

### Q: enriched_context 为空怎么办？

**A:**

- Qodo 评论：从 `primary_comment_body` 解析 Emoji 类型
- Sourcery 评论：从 Prompt for AI Agents 映射
- Copilot 评论：默认为 "suggestion"

### Q: 总览意见需要解决吗？

**A:** 总览意见无法"解决"，只能"确认"已阅读。使用 `acknowledge` 命令。

## 相关文档

- [评论处理系统说明](评论处理系统说明.md) - 完整系统文档
- [AI 审查工具参考指南（归档）](archive/v1-ai-reviewer-guide.md) - 降级策略
- [fetch-reviews Skill](../../.trae/skills/fetch-reviews/SKILL.md) - Skill 使用说明
- [resolve-review-comment Skill](../../.trae/skills/resolve-review-comment/SKILL.md) - 解决评论说明
- [acceptance-workflow Skill](../../.trae/skills/acceptance-workflow/SKILL.md) - 完整验收流程
