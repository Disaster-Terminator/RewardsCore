# 登录系统测试指南

## 测试目的

验证登录系统的各个功能是否正常工作，包括：
- 登录状态检测
- 会话持久化
- 自动登录（状态机）
- 手动登录
- 错误处理

## 测试前准备

### 1. 备份现有会话
```bash
# 如果已有登录状态，先备份
copy storage_state.json storage_state.backup.json
```

### 2. 检查配置文件
确保 `config.yaml` 中的登录配置正确：

```yaml
account:
  email: "your-email@example.com"
  password: "your-password"
  totp_secret: ""  # 如果启用了2FA，填写TOTP密钥
  storage_state_path: "storage_state.json"
  login_url: "https://rewards.microsoft.com/"

login:
  state_machine_enabled: true  # 测试自动登录时设为true
  max_transitions: 10
  timeout_seconds: 300
  stay_signed_in: true
```

### 3. 准备测试脚本
创建一个简单的测试脚本 `test_login.py`（见下文）

---

## 测试场景

### 场景1：首次登录（无会话文件）

**目的**：测试从零开始的登录流程

**步骤**：
1. 删除现有会话文件
   ```bash
   del storage_state.json
   ```

2. 运行测试脚本
   ```bash
   python test_login.py --scenario first-login
   ```

3. **观察并记录**：
   - [ ] 浏览器是否正常打开？
   - [ ] 是否导航到登录页面？
   - [ ] 登录状态检测是否正确识别为"未登录"？
   - [ ] 如果启用状态机，是否自动填写邮箱？
   - [ ] 如果启用状态机，是否自动填写密码？
   - [ ] 如果需要2FA，是否正确处理？
   - [ ] 登录成功后，是否保存会话文件？
   - [ ] 会话文件大小是否合理（>1KB）？

**预期结果**：
- 成功登录
- 生成 `storage_state.json` 文件
- 日志显示 "✓ 登录完成，会话已保存"

**如果失败，记录**：
- 失败在哪一步？
- 错误信息是什么？
- 截图保存位置

---

### 场景2：使用已有会话登录

**目的**：测试会话持久化是否有效

**步骤**：
1. 确保 `storage_state.json` 存在（场景1生成的）

2. 运行测试脚本
   ```bash
   python test_login.py --scenario existing-session
   ```

3. **观察并记录**：
   - [ ] 是否加载了会话文件？
   - [ ] 日志是否显示 "✓ 加载会话状态成功: X 个 cookies"？
   - [ ] 打开页面后是否直接显示已登录状态？
   - [ ] 登录状态检测是否正确识别为"已登录"？
   - [ ] 是否跳过了登录流程？

**预期结果**：
- 直接识别为已登录
- 不需要重新输入账号密码
- 日志显示 "✓ 用户已登录"

**如果失败，记录**：
- 会话文件是否被正确加载？
- 是否仍然跳转到登录页面？
- Cookie是否有效？

---

### 场景3：会话过期处理

**目的**：测试会话过期后的处理

**步骤**：
1. 使用一个旧的会话文件（或手动修改Cookie过期时间）

2. 运行测试脚本
   ```bash
   python test_login.py --scenario expired-session
   ```

3. **观察并记录**：
   - [ ] 是否检测到会话无效？
   - [ ] 是否自动触发重新登录？
   - [ ] 重新登录是否成功？
   - [ ] 是否更新了会话文件？

**预期结果**：
- 检测到会话无效
- 自动重新登录
- 更新会话文件

---

### 场景4：登录状态检测准确性

**目的**：测试多重检测机制的准确性

**步骤**：
1. 运行检测测试
   ```bash
   python test_login.py --scenario detection-test
   ```

2. **观察并记录**：
   - [ ] 用户元素检测结果
   - [ ] Cookie检测结果
   - [ ] API响应检测结果
   - [ ] 页面内容检测结果
   - [ ] 最终投票结果
   - [ ] 检测耗时

3. 手动验证：
   - 如果显示"已登录"，检查页面是否真的已登录
   - 如果显示"未登录"，检查页面是否真的未登录

**预期结果**：
- 至少3种检测方法返回一致结果
- 最终结果与实际状态一致
- 检测时间 < 10秒

---

### 场景5：自动登录（状态机）

**目的**：测试登录状态机的自动登录功能

**前提**：
- 配置文件中已填写邮箱和密码
- `login.state_machine_enabled: true`

**步骤**：
1. 删除会话文件
   ```bash
   del storage_state.json
   ```

2. 运行自动登录测试
   ```bash
   python test_login.py --scenario auto-login
   ```

3. **观察并记录**：
   - [ ] 是否自动检测到邮箱输入页面？
   - [ ] 是否自动填写邮箱？
   - [ ] 是否自动点击"下一步"？
   - [ ] 是否自动检测到密码输入页面？
   - [ ] 是否自动填写密码？
   - [ ] 是否自动点击"登录"？
   - [ ] 如果有"保持登录"提示，是否正确处理？
   - [ ] 状态转换次数是多少？
   - [ ] 总耗时是多少？

**预期结果**：
- 完全自动完成登录
- 状态转换次数 < 5次
- 总耗时 < 60秒
- 日志显示 "✓ 自动登录成功！"

**如果失败，记录**：
- 卡在哪个状态？
- 状态转换历史
- 错误信息

---

### 场景6：2FA登录（如果启用）

**目的**：测试TOTP双因素认证

**前提**：
- 账户启用了2FA
- 配置文件中填写了 `totp_secret`

**步骤**：
1. 删除会话文件

2. 运行2FA测试
   ```bash
   python test_login.py --scenario 2fa-login
   ```

3. **观察并记录**：
   - [ ] 是否检测到2FA页面？
   - [ ] 是否自动生成TOTP验证码？
   - [ ] 验证码格式是否正确（6位数字）？
   - [ ] 是否自动填写验证码？
   - [ ] 验证码是否被接受？
   - [ ] 登录是否成功？

**预期结果**：
- 自动生成并填写验证码
- 验证码被接受
- 成功登录

**如果失败，记录**：
- TOTP密钥是否正确？
- 系统时间是否同步？
- 验证码是否过期？

---

### 场景7：手动登录（降级方案）

**目的**：测试手动登录作为备用方案

**步骤**：
1. 在配置中禁用状态机
   ```yaml
   login:
     state_machine_enabled: false
   ```

2. 删除会话文件

3. 运行手动登录测试
   ```bash
   python test_login.py --scenario manual-login
   ```

4. **观察并记录**：
   - [ ] 是否提示"请在浏览器中手动登录"？
   - [ ] 浏览器是否保持打开状态？
   - [ ] 手动登录后，是否自动检测到登录成功？
   - [ ] 是否保存会话文件？

**预期结果**：
- 提示手动登录
- 等待用户操作
- 检测到登录后自动继续
- 保存会话

---

### 场景8：错误处理

**目的**：测试各种错误情况的处理

**8.1 错误的密码**
1. 在配置中填写错误的密码
2. 运行测试
3. **观察**：
   - [ ] 是否检测到登录失败？
   - [ ] 错误信息是否清晰？
   - [ ] 是否有重试机制？

**8.2 网络超时**
1. 在登录过程中断开网络
2. **观察**：
   - [ ] 是否检测到超时？
   - [ ] 错误信息是否清晰？
   - [ ] 是否有重试机制？

**8.3 页面结构变化**
1. 模拟Microsoft更新了页面（修改选择器）
2. **观察**：
   - [ ] 是否检测到选择器失效？
   - [ ] 是否有降级方案？
   - [ ] 错误信息是否有助于调试？

---

## 测试记录表

| 场景 | 测试时间 | 结果 | 问题描述 | 截图/日志 |
|------|---------|------|---------|----------|
| 场景1：首次登录 | | ⬜ 通过 ⬜ 失败 | | |
| 场景2：已有会话 | | ⬜ 通过 ⬜ 失败 | | |
| 场景3：会话过期 | | ⬜ 通过 ⬜ 失败 | | |
| 场景4：状态检测 | | ⬜ 通过 ⬜ 失败 | | |
| 场景5：自动登录 | | ⬜ 通过 ⬜ 失败 | | |
| 场景6：2FA登录 | | ⬜ 通过 ⬜ 失败 | | |
| 场景7：手动登录 | | ⬜ 通过 ⬜ 失败 | | |
| 场景8：错误处理 | | ⬜ 通过 ⬜ 失败 | | |

---

## 性能指标

记录以下性能数据：

| 指标 | 目标值 | 实际值 | 备注 |
|------|--------|--------|------|
| 首次登录耗时 | < 60秒 | | |
| 会话加载耗时 | < 5秒 | | |
| 状态检测耗时 | < 10秒 | | |
| 自动登录成功率 | > 95% | | 测试10次 |
| 会话有效期 | > 7天 | | |

---

## 问题报告模板

如果发现问题，请按以下格式记录：

```
### 问题标题
[简短描述问题]

**场景**：场景X - XXX

**复现步骤**：
1. 
2. 
3. 

**预期结果**：
[应该发生什么]

**实际结果**：
[实际发生了什么]

**环境信息**：
- 操作系统：
- Python版本：
- Playwright版本：
- 浏览器版本：

**日志片段**：
```
[粘贴相关日志]
```

**截图**：
[如果有，附上截图路径]

**诊断信息**：
[如果有状态机诊断信息，粘贴在这里]
```

---

## 测试完成后

1. **汇总结果**
   - 通过的场景数：__ / 8
   - 发现的问题数：__
   - 严重问题数：__

2. **优先级排序**
   - P0（阻塞性问题）：
   - P1（重要问题）：
   - P2（一般问题）：

3. **下一步行动**
   - [ ] 修复P0问题
   - [ ] 优化性能
   - [ ] 改进用户体验
   - [ ] 更新文档

---

## 注意事项

⚠️ **测试时请注意**：
1. 每个场景测试前，确保环境干净（删除旧会话文件）
2. 记录详细的日志和截图
3. 如果某个场景失败，不要急于进入下一个场景
4. 测试过程中不要修改代码，先完成所有测试
5. 保存所有测试数据，便于后续分析

⚠️ **安全提醒**：
- 测试完成后，删除配置文件中的明文密码
- 不要将包含密码的配置文件提交到Git
- 测试日志可能包含敏感信息，注意保护
