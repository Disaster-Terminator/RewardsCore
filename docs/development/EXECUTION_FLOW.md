# MS Rewards Automator - 执行流程文档

## 完整执行流程

### 模式1: 仅桌面模式 (`--desktop-only`)
```
1. 初始化组件
2. 创建桌面浏览器
3. 检查登录状态
4. 检查初始积分
5. 执行桌面搜索 (N次)
6. 执行日常任务 (在同一浏览器)
7. 生成报告
8. 关闭浏览器
```

### 模式2: 桌面+移动模式 (默认)
```
1. 初始化组件
2. 创建桌面浏览器
3. 检查登录状态
4. 检查初始积分
5. 执行桌面搜索 (N次)
6. 【浏览器切换】
   - 保存桌面会话 (可能触发beforeunload)
   - 关闭桌面浏览器
   - 创建移动浏览器
7. 执行移动搜索 (M次)
8. 【浏览器切换】
   - 保存移动会话
   - 关闭移动浏览器
   - 创建桌面浏览器
9. 执行日常任务
10. 生成报告
11. 关闭浏览器
```

## 关键问题点

### 1. beforeunload 对话框
**位置**: 步骤6 - 保存桌面会话时
**现象**: 弹出"确定要离开，可能不会保存更改的框"
**原因**: Bing页面有beforeunload监听器
**解决方案**: ✅ 已在 `account_manager.save_session()` 中处理
- 禁用所有页面的beforeunload
- 自动接受dialog
- 覆盖confirm/alert

### 2. 会话保存次数
**当前**: 保存2次（桌面→移动，移动→桌面）
**优化方向**: 
- 考虑只在最后保存一次
- 或者使用更轻量的状态传递

### 3. 浏览器切换开销
**当前**: 完整的关闭→创建→加载
**耗时**: 每次切换约5-10秒
**优化方向**: 
- 考虑使用同一浏览器的不同user-agent
- 或者保持两个浏览器实例

## 任务系统执行流程

### 任务发现阶段
```
1. 导航到 Dashboard (https://rewards.microsoft.com/)
2. 等待页面加载 (domcontentloaded, 15秒超时)
3. 查找任务元素 (3种选择器策略)
4. 提取任务元数据:
   - 任务ID
   - 任务类型 (6种识别策略)
   - 标题
   - 积分
   - 完成状态
   - 目标URL
5. 创建任务对象
```

### 任务过滤阶段
```
过滤规则 (按顺序):
1. 积分 = 0? → 跳过 (抽奖、目标设置)
2. 包含关键词? → 跳过 (拼图、问答等)
3. 任务类型禁用? → 跳过 (quiz、poll)
4. 已完成? → 跳过
5. URL无效? → 跳过 (空、特殊协议)

通过所有过滤 → 执行
```

### 任务执行阶段
```
对于每个任务:
1. 检查完成状态 → 已完成则跳过
2. 导航到任务URL
3. 等待页面加载 (domcontentloaded, 15秒超时)
4. 等待1秒让页面稳定
5. 标记为完成
6. 延迟1-2秒后执行下一个任务
```

## 配置参数

### 搜索配置
```yaml
search:
  desktop_count: 30  # 桌面搜索次数
  mobile_count: 20   # 移动搜索次数
```

### 任务系统配置
```yaml
task_system:
  enabled: true
  min_delay: 1       # 任务间最小延迟(秒)
  max_delay: 2       # 任务间最大延迟(秒)
  skip_completed: true
  debug_mode: true
  
  task_types:
    url_reward: true   # 只启用URL任务
    quiz: false        # 禁用问答
    poll: false        # 禁用投票
```

## 性能指标

### 预期执行时间
- 桌面搜索: ~2-3分钟 (30次 × 4-6秒)
- 移动搜索: ~1.5-2分钟 (20次 × 4-6秒)
- 浏览器切换: ~10-15秒 (×2)
- 任务执行: ~30-60秒 (取决于任务数量)
- **总计**: 约5-7分钟

### 预期积分
- 桌面搜索: 150分 (30次 × 5分)
- 移动搜索: 100分 (20次 × 5分)
- 日常任务: 30-50分 (URL任务)
- **总计**: 280-300分/天

## 故障排查

### 问题1: beforeunload卡死
**症状**: 保存会话时卡住，超时
**检查**: 
1. `account_manager.save_session()` 是否正确禁用beforeunload
2. dialog监听器是否正常工作
3. 日志中是否有 "✓ 已禁用页面的 beforeunload"

### 问题2: 任务识别失败
**症状**: "未发现任何任务"
**检查**:
1. debug_mode是否启用
2. 查看 `logs/diagnostics/` 中的截图和HTML
3. 检查选择器是否失效

### 问题3: 任务执行失败
**症状**: 任务标记为失败
**检查**:
1. URL是否有效
2. 是否被过滤规则跳过
3. 页面加载是否超时

## 优化建议

### 短期优化
1. ✅ 只执行URL任务（已实现）
2. ✅ 跳过0积分任务（已实现）
3. ✅ 跳过已完成任务（已实现）
4. ⏳ 减少浏览器切换次数

### 长期优化
1. 实现Quiz任务处理器
2. 实现Poll任务处理器
3. 添加任务重试机制
4. 优化浏览器切换策略
5. 添加积分变化监控
